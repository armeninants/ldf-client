<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<script src="./dependencies/jquery-2.1.0.js"></script>
<script src="./dependencies/ldf-client-browser.js"></script>
<script src="./dependencies/prefixes.js"></script>

<!--
Element providing solution to no problem in particular.

##### Example

    <polymer-ldf-client></polymer-ldf-client>

@element polymer-ldf-client
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://github.com/tomayac/polymer-ldf-client-
-->
<polymer-element name="polymer-ldf-client" hidden attributes="startFragment query responseFormat">
  <script>
    Polymer({

      DEBUG: true,

      query: '',

      startFragment: '',

      responseFormat: 'streaming',

      ready: function() {
        this.executeQuery();
      },

      executeQuery: function() {
        var that = this;
        if (!this.query) {
          this.DEBUG && console.log('No query given.');
          return;
        }
        if (!this.startFragment) {
          this.DEBUG && console.log('No start fragment given.');
          return;
        }

        this.DEBUG && console.log('Query:\n' + this.query);
        this.DEBUG && console.log('Start fragment:\n' + this.startFragment);

        var fragmentsClient = new ldf.FragmentsClient(this.startFragment);
        var results = new ldf.SparqlIterator(this.query, {
          fragmentsClient: fragmentsClient,
        });

        var data = '';
        if (this.responseFormat === 'streaming') {
          // Partial response
          results.on('data', function (chunk) {
            data += chunk;
            that.fire('ldf-query-streaming-partial-response', chunk);
          });
          // Complete response
          results.on('end', function () {
            that.fire('ldf-query-streaming-response-end', data);
          });
        } else if (this.responseFormat === 'polling') {
          (function showNext() {
            var result = results.read();
            if (result === null) {
              results.once('readable', showNext);
            } else {
              data += JSON.stringify(result);
              that.fire('ldf-query-polling-response', data);
            }
          })();
        }
      }
    });
  </script>
</polymer-element>
